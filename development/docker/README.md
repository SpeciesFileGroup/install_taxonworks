

# Development quick start

You can quickly start developing or testing against the API with minimal configuration.  The following assumes you have cloned the taxonworks source and have docker and its dependencies (like a VM) installed.  
* `git clone https://github.com/SpeciesFileGroup/taxonworks.git` - to clone repository in directory of your choice
* `cd /path/to/taxonworks`
* `docker-compose build`
* `docker-compose up`
*  browse to `127.0.0.1:3000` if you can see something similar to below in your terminal window:
    ```
    app_1      | [2017-10-22 02:02:03] INFO  WEBrick::HTTPServer#start: pid=25 port=3000
    ```
* You should see the logon window. Minimally, you need to now _Create a user_ or _Restore a database dump_
* Wait for a while if the logon window does not load not load quickly. 
* Use `ctrl-c` or `docker-compose down` in another local terminal to shutdown

# Overview
* See [documentation for Docker](https://docs.docker.com/).
* In TaxonWorks `docker-compose` is configured to use  [Dockerfile.development](https://raw.githubusercontent.com/SpeciesFileGroup/taxonworks/development/Dockerfile.development)

## Get the names and IDs of your containers

* `docker ps`

## Shell into the app

Use the name of your app as provided from `docker ps`

* `docker exec -it taxonworks_app_1 bash`

## Create a user

Assumes you want an otherwise empty database/application.

* Shell into the app 
* `rails c`
*  `User.create!(name: 'you', password: 'password', password_confirmation: 'password', self_created: true, is_administrator: true, email: 'user@example.com')`
* `quit`

## Develop!

* The container is mapped to the source on your local machine, what you see when you shell into the app is what is on your local file system.
* To make changes simply edit the source that you cloned.
* Changes are automatically applied and visible in the browser as they would be for the native environment.
* In most cases you need not restart the server or redo `docker-compose up`. 
* See the Rails documentation for more.

## Use a debugger like byebug or pry

Two steps. Run docker-compose in daemon mode, then attach to the app. Server log/debugger entry point will appear in the window after requests.

* `docker-compose up -d`
* `docker attach taxonworks_app_1` 

## Stop a container

Get the container id from `docker ps`

* `docker stop 3dc4293eg17e`  

# Database

The database persists across use.  By default it is *not* the same as database described in the "native" environment approach.

## Drop and recreate the database to an empty state

* Ensure the app (usually `taxonworks_app_1`) is not running (_Stop a container_), the database container needs to be running.
* `psql -U postgres -p 15432 -h 0.0.0.0 taxonworks_development`
* `drop database taxonworks_development`
* `create database taxonworks_development`
* `\q`

## Restore a database dump

Assumes you have a prior export generated by `rake tw:db:dump`

* Drop and recreate the database to an empty state
* `pg_restore -U postgres -p 15432 -h 0.0.0.0 -d taxonworks_development /path/to/pg_dump.dump`
* Depending on when the database was dumped restore errors about roles can be ignored, i.e. the process will "fail" but be successful.

# Troubleshooting
## "docker-compose up" fails

### With "A server is already running"
* If an app container is not shut down correctly (`docker-compose down`) it can leave the file `tmp/server.pid`
* On the _local_ file system check to see if `/app/tmp/pids/server.pid` exists, if it does, delete it.

### With `(Bundler::GemNotFound)`
* Bring down the containers `docker-compose down`
* Rebuild the containers `docker-compose build`

## Cleanup old containers

*  Try `docker images` and `docker rmi <id>` to cleanup old iamges. 

## Log reports Gem not found

* Redo `docker-compose build` to get the latest gems.  You will need to do this whenever the Gemfile or Gemfile.lock is updated.

## `docker-compose build` fails after `RUN apt-add-repository ppa:brightbox/ruby-ng`

* Problem: It seems that sometimes the repository list update fails because of bad(?) internet connection. Difficult to replicate. 
* Solution: Do nothing, just re-run `docker-compose build` again.

## Migration related error
* Problem: Active Migration related error is observed in client browser after following installation process.
* Solution: Try go through solution in this [issue](https://github.com/SpeciesFileGroup/taxonworks/issues/250) and see if it works. Otherwise, re-open the [issue](https://github.com/SpeciesFileGroup/taxonworks/issues/250) with your problem.
