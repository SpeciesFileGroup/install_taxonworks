# Overview

* docker-compose is configured with `Dockerfile.development`

# Development quick start

You can quickly start developing or testing against the API with minimal configuration.  The following assumes you have cloned the taxonworks source and have docker and its dependencies (like a VM) installed.

* `cd /path/to/taxonworks`
* `cp config/database.yml.docker.compose config/database.yml` 
* `docker-compose build`
* `docker-compose up`
* browse to `127.0.0.1:3000`
* ... you chould see the logon window, to logon you minimally need to Create a user...
* `docker-compose down`

# General use 

See [Docker docs](https://docs.docker.com/).

## Get the names and IDs of your containers

* `docker ps`

## Shell into the app

Use the name of your app as provided from `docker ps`

* `docker exec -it taxonworks_app_1 bash`

## Create a user

Assumes you want a completely empty application.

* Shell into the app 
* `rails c`
*  `User.create!(name: 'you', password: 'password', password_confirmation: 'password', self_created: true, is_administrator: true, email: 'user@example.com')`
* `quit`

## Use a debugger like byebug or pry

Two steps.  Run docker-compose in daemon mode, then attach to the app. Server log/debugger entry point will appear in the window after requests.

* `docker-compose up -d`
* `docker attach taxonworks_app_1` 

## Stop a container

Get the container id from `docker ps`

* `docker stop 3dc4293eg17e`  

# Database

The database persists across use.

## Drop and recreate the database to an empty state

* Ensure the app is not running (stop a container above)
* `psql -U postgres -p 15432 -h 0.0.0.0 taxonworks_development`
* `drop database taxonworks_development`
* `create database taxonworks_development`
* `\q`

## Restore a database dump

Assumes you have a prior export generated by `rake tw:db:dump`

* Drop and recreate the database to an empty state
* `pg_restore -U postgres -p 15432 -h 0.0.0.0 -d taxonworks_development /path/to/pg_dump.dump`
* Depending on when the database was dumped restore errors about roles can be ignored, i.e. the process will "fail" but be successful.

# Troubleshooting

## "docker-compose up" fails

* With `A server is already running. Check /app/tmp/pids/server.pid.` If a the app container is not shut down correctly it can leave `tmp/server.pid` in place.  Delete this file on the local system.
* With `(Bundler::GemNotFound)`. Rebuild the containers: `docker-compose build`

## Cleanup old containers

*  Try `docker images` and `docker rmi <id>` to cleanup old iamges. 


