# Overview

* `docker-compose` is configured with `Dockerfile.development`

# Development quick start

You can quickly start developing or testing against the API with minimal configuration.  The following assumes you have cloned the taxonworks source and have docker and its dependencies (like a VM) installed.  

* `cd /path/to/taxonworks`
* `cp config/database.yml.docker.compose config/database.yml` 
* `docker-compose build`
* `docker-compose up`
* browse to `127.0.0.1:3000`
* ... you chould see the logon window, minimally, to logon you need to _Create a user_ ...
* `docker-compose down`

# General use 

See [Docker docs](https://docs.docker.com/).

## Get the names and IDs of your containers

* `docker ps`

## Shell into the app

Use the name of your app as provided from `docker ps`

* `docker exec -it taxonworks_app_1 bash`

## Create a user

Assumes you want an otherwise empty database/application.

* Shell into the app 
* `rails c`
*  `User.create!(name: 'you', password: 'password', password_confirmation: 'password', self_created: true, is_administrator: true, email: 'user@example.com')`
* `quit`

## Develop!

* The container is mapped to the source on your local machine, what you see when you shell into the app is what is on your local file system.
* To make changes simply edit the source that you cloned.
* Changes are automatically applied and visible in the browser as they would be for the native environment.
* In most cases you need not restart the server or redo `docker-compose up`. 
* See the Rails documentation for more.

## Use a debugger like byebug or pry

Two steps. Run docker-compose in daemon mode, then attach to the app. Server log/debugger entry point will appear in the window after requests.

* `docker-compose up -d`
* `docker attach taxonworks_app_1` 

## Stop a container

Get the container id from `docker ps`

* `docker stop 3dc4293eg17e`  

# Database

The database persists across use.  By default it is *not* the same as database described in the "native" environment approach.

## Drop and recreate the database to an empty state

* Ensure the app is not running (stop a container above)
* `psql -U postgres -p 15432 -h 0.0.0.0 taxonworks_development`
* `drop database taxonworks_development`
* `create database taxonworks_development`
* `\q`

## Restore a database dump

Assumes you have a prior export generated by `rake tw:db:dump`

* Drop and recreate the database to an empty state
* `pg_restore -U postgres -p 15432 -h 0.0.0.0 -d taxonworks_development /path/to/pg_dump.dump`
* Depending on when the database was dumped restore errors about roles can be ignored, i.e. the process will "fail" but be successful.

# Troubleshooting
## "docker-compose up" fails

### With "A server is already running"
* If an app container is not shut down correctly (`docker-compose down`) it can leave the file `tmp/server.pid`
* On the _local_ file system check to see if `/app/tmp/pids/server.pid` exists, if it does, delete it.

### With `(Bundler::GemNotFound)`
* Bring down the containers `docker-compose down`
* Rebuild the containers `docker-compose build`

## Cleanup old containers

*  Try `docker images` and `docker rmi <id>` to cleanup old iamges. 

## Log reports Gem not found

* Redo `docker-compose build` to get the latest gems.  You will need to do this whenever the Gemfile or Gemfile.lock is updated.
